# Makefile for Clipboard Manager

.PHONY: build test clean install uninstall help deps run daemon show build-all release test-coverage dist

# Default target
all: build

# Build the clipboard manager
build:
	@echo "üî® Building Clipboard Manager..."
	@mkdir -p build
	go build -o clipboard-manager
	@cp clipboard-manager build/
	@echo "‚úÖ Build completed!"
	@echo "   ‚Ä¢ Main binary: ./clipboard-manager"
	@echo "   ‚Ä¢ Build copy: ./build/clipboard-manager"

# Build different variants
build-all:
	@echo "üî® Building all variants..."
	@mkdir -p build
	@echo "Building standard version..."
	go build -o build/clipboard-manager
	@echo "Building with debug info..."
	go build -gcflags="all=-N -l" -o build/clipboard-manager-debug
	@echo "Building optimized version..."
	go build -ldflags="-s -w" -o build/clipboard-manager-optimized
	@echo "‚úÖ All builds completed!"
	@ls -la build/clipboard-manager*

# Create release package with binaries for different architectures
release: clean
	@echo "üì¶ Creating release binaries for multiple architectures..."
	@mkdir -p build/release
	
	@echo "Building for Linux x86_64..."
	CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o build/release/clipboard-manager-linux-amd64
	
	@echo "Building for Linux ARM64 (may require cross-compilation tools)..."
	@if command -v aarch64-linux-gnu-gcc >/dev/null 2>&1; then \
		CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o build/release/clipboard-manager-linux-arm64 || \
		echo "‚ö†Ô∏è  ARM64 build failed - cross-compilation tools may be missing"; \
	else \
		echo "‚ö†Ô∏è  Skipping ARM64 build - cross-compilation tools not available"; \
		echo "   Install with: sudo apt install gcc-aarch64-linux-gnu"; \
	fi
	
	@echo "Building for Linux x86 (32-bit)..."
	@if command -v gcc-multilib >/dev/null 2>&1 || dpkg -l | grep -q gcc-multilib; then \
		CGO_ENABLED=1 GOOS=linux GOARCH=386 go build -ldflags="-s -w" -o build/release/clipboard-manager-linux-386 || \
		echo "‚ö†Ô∏è  32-bit build failed"; \
	else \
		echo "‚ö†Ô∏è  Skipping 32-bit build - multilib not available"; \
		echo "   Install with: sudo apt install gcc-multilib"; \
	fi
	
	@echo "Creating comprehensive installation script..."
	@cp scripts/install-template.sh build/release/install.sh
	@echo 'set -e' >> build/release/install.sh
	@echo '' >> build/release/install.sh
	@echo 'echo "üöÄ Installing Clipboard Manager..."' >> build/release/install.sh
	@echo '' >> build/release/install.sh
	@echo '# Detect architecture and find available binary' >> build/release/install.sh
	@echo 'ARCH=$$(uname -m)' >> build/release/install.sh
	@echo 'BINARY=""' >> build/release/install.sh
	@echo '' >> build/release/install.sh
	@echo '# Try to find the best binary for this architecture' >> build/release/install.sh
	@echo 'case $$ARCH in' >> build/release/install.sh
	@echo '    x86_64)' >> build/release/install.sh
	@echo '        if [ -f "clipboard-manager-linux-amd64" ]; then' >> build/release/install.sh
	@echo '            BINARY="clipboard-manager-linux-amd64"' >> build/release/install.sh
	@echo '        fi ;;' >> build/release/install.sh
	@echo '    aarch64|arm64)' >> build/release/install.sh
	@echo '        if [ -f "clipboard-manager-linux-arm64" ]; then' >> build/release/install.sh
	@echo '            BINARY="clipboard-manager-linux-arm64"' >> build/release/install.sh
	@echo '        elif [ -f "clipboard-manager-linux-amd64" ]; then' >> build/release/install.sh
	@echo '            echo "‚ö†Ô∏è  ARM64 binary not available, trying x86_64 (may not work)"' >> build/release/install.sh
	@echo '            BINARY="clipboard-manager-linux-amd64"' >> build/release/install.sh
	@echo '        fi ;;' >> build/release/install.sh
	@echo '    i386|i686)' >> build/release/install.sh
	@echo '        if [ -f "clipboard-manager-linux-386" ]; then' >> build/release/install.sh
	@echo '            BINARY="clipboard-manager-linux-386"' >> build/release/install.sh
	@echo '        elif [ -f "clipboard-manager-linux-amd64" ]; then' >> build/release/install.sh
	@echo '            echo "‚ö†Ô∏è  32-bit binary not available, trying x86_64"' >> build/release/install.sh
	@echo '            BINARY="clipboard-manager-linux-amd64"' >> build/release/install.sh
	@echo '        fi ;;' >> build/release/install.sh
	@echo '    *)' >> build/release/install.sh
	@echo '        echo "‚ö†Ô∏è  Unknown architecture: $$ARCH, trying x86_64 binary"' >> build/release/install.sh
	@echo '        if [ -f "clipboard-manager-linux-amd64" ]; then' >> build/release/install.sh
	@echo '            BINARY="clipboard-manager-linux-amd64"' >> build/release/install.sh
	@echo '        fi ;;' >> build/release/install.sh
	@echo 'esac' >> build/release/install.sh
	@echo '' >> build/release/install.sh
	@echo 'if [ -z "$$BINARY" ]; then' >> build/release/install.sh
	@echo '    echo "‚ùå No compatible binary found for architecture: $$ARCH"' >> build/release/install.sh
	@echo '    echo "Available binaries:"' >> build/release/install.sh
	@echo '    ls -1 clipboard-manager-linux-* 2>/dev/null || echo "  None found"' >> build/release/install.sh
	@echo '    exit 1' >> build/release/install.sh
	@echo 'fi' >> build/release/install.sh
	@echo '' >> build/release/install.sh
	@echo 'echo "üì• Installing $$BINARY to /usr/local/bin/clipboard-manager..."' >> build/release/install.sh
	@echo 'sudo cp "$$BINARY" /usr/local/bin/clipboard-manager' >> build/release/install.sh
	@echo 'sudo chmod +x /usr/local/bin/clipboard-manager' >> build/release/install.sh
	@echo '' >> build/release/install.sh
	@echo 'echo "üîß Setting up desktop integration..."' >> build/release/install.sh
	@echo 'mkdir -p ~/.local/share/applications' >> build/release/install.sh
	@echo 'cat > ~/.local/share/applications/clipboard-manager.desktop << EOF' >> build/release/install.sh
	@echo '[Desktop Entry]' >> build/release/install.sh
	@echo 'Name=Clipboard Manager' >> build/release/install.sh
	@echo 'Comment=Clipboard history manager for Linux' >> build/release/install.sh
	@echo 'Exec=/usr/local/bin/clipboard-manager show' >> build/release/install.sh
	@echo 'Icon=edit-copy' >> build/release/install.sh
	@echo 'Terminal=false' >> build/release/install.sh
	@echo 'Type=Application' >> build/release/install.sh
	@echo 'Categories=Utility;' >> build/release/install.sh
	@echo 'Keywords=clipboard;history;copy;paste;' >> build/release/install.sh
	@echo 'EOF' >> build/release/install.sh
	@echo '' >> build/release/install.sh
	@echo 'echo "üîë Setting up hotkey (Ctrl+Shift+V)..."' >> build/release/install.sh
	@echo '/usr/local/bin/clipboard-manager daemon > /dev/null 2>&1 &' >> build/release/install.sh
	@echo '' >> build/release/install.sh
	@echo 'echo "üöÄ Setting up autostart..."' >> build/release/install.sh
	@echo 'mkdir -p ~/.config/autostart' >> build/release/install.sh
	@echo 'cat > ~/.config/autostart/clipboard-manager.desktop << EOF' >> build/release/install.sh
	@echo '[Desktop Entry]' >> build/release/install.sh
	@echo 'Name=Clipboard Manager' >> build/release/install.sh
	@echo 'GenericName=Clipboard History Manager' >> build/release/install.sh
	@echo 'Comment=Clipboard history manager with Ctrl+Shift+V hotkey' >> build/release/install.sh
	@echo 'Exec=/usr/local/bin/clipboard-manager daemon' >> build/release/install.sh
	@echo 'Icon=edit-copy' >> build/release/install.sh
	@echo 'Terminal=false' >> build/release/install.sh
	@echo 'Type=Application' >> build/release/install.sh
	@echo 'Categories=Utility;System;Accessibility;' >> build/release/install.sh
	@echo 'Keywords=clipboard;history;copy;paste;hotkey;' >> build/release/install.sh
	@echo 'X-GNOME-Autostart-enabled=true' >> build/release/install.sh
	@echo 'X-KDE-autostart-after=panel' >> build/release/install.sh
	@echo 'X-MATE-Autostart-enabled=true' >> build/release/install.sh
	@echo 'X-XFCE-Autostart-enabled=true' >> build/release/install.sh
	@echo 'Hidden=false' >> build/release/install.sh
	@echo 'NoDisplay=false' >> build/release/install.sh
	@echo 'StartupNotify=false' >> build/release/install.sh
	@echo 'X-GNOME-Autostart-Delay=3' >> build/release/install.sh
	@echo 'X-KDE-StartupNotify=false' >> build/release/install.sh
	@echo 'OnlyShowIn=GNOME;KDE;XFCE;MATE;Unity;Cinnamon;Pantheon;LXQt;LXDE;' >> build/release/install.sh
	@echo 'EOF' >> build/release/install.sh
	@echo '' >> build/release/install.sh
	@echo 'echo "‚úÖ Installation completed!"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Binary: /usr/local/bin/clipboard-manager"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Desktop entry: ~/.local/share/applications/clipboard-manager.desktop"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Autostart entry: ~/.config/autostart/clipboard-manager.desktop"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Hotkey: Ctrl+Shift+V (configured automatically)"' >> build/release/install.sh
	@echo 'echo ""' >> build/release/install.sh
	@echo 'echo "üöÄ Startup Application:"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Added to system startup applications list"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Will start automatically on login"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Visible in your desktop'\''s startup applications manager"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Can be managed through System Settings > Startup Applications"' >> build/release/install.sh
	@echo 'echo ""' >> build/release/install.sh
	@echo 'echo "Usage:"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Press Ctrl+Shift+V from anywhere to open clipboard history"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Clipboard manager will start automatically on login"' >> build/release/install.sh
	@echo 'echo "   ‚Ä¢ Run clipboard-manager help for more options"' >> build/release/install.sh
	
	@chmod +x build/release/install.sh
	
	@echo "Copying documentation..."
	@cp README.md build/release/
	@cp INSTALL.md build/release/
	@cp LICENSE build/release/ 2>/dev/null || echo "LICENSE file not found, skipping..."
	
	@echo "Creating usage instructions..."
	@echo '# Clipboard Manager - Pre-built Release' > build/release/README-RELEASE.md
	@echo '' >> build/release/README-RELEASE.md
	@echo '## Quick Installation (No Go Required)' >> build/release/README-RELEASE.md
	@echo '' >> build/release/README-RELEASE.md
	@echo '```bash' >> build/release/README-RELEASE.md
	@echo '# Make install script executable and run it' >> build/release/README-RELEASE.md
	@echo 'chmod +x install.sh' >> build/release/README-RELEASE.md
	@echo './install.sh' >> build/release/README-RELEASE.md
	@echo '```' >> build/release/README-RELEASE.md
	@echo '' >> build/release/README-RELEASE.md
	@echo 'That'\''s it! Press **Super+V** to open clipboard history.' >> build/release/README-RELEASE.md
	@echo '' >> build/release/README-RELEASE.md
	@echo '## Manual Installation' >> build/release/README-RELEASE.md
	@echo '' >> build/release/README-RELEASE.md
	@echo '1. Choose the right binary for your system:' >> build/release/README-RELEASE.md
	@echo '   - `clipboard-manager-linux-amd64` - 64-bit Intel/AMD (most common)' >> build/release/README-RELEASE.md
	@echo '   - `clipboard-manager-linux-arm64` - 64-bit ARM (Raspberry Pi 4, Apple Silicon)' >> build/release/README-RELEASE.md
	@echo '   - `clipboard-manager-linux-386` - 32-bit Intel/AMD (older systems)' >> build/release/README-RELEASE.md
	@echo '' >> build/release/README-RELEASE.md
	@echo '2. Install manually:' >> build/release/README-RELEASE.md
	@echo '```bash' >> build/release/README-RELEASE.md
	@echo '# Replace with your architecture' >> build/release/README-RELEASE.md
	@echo 'sudo cp clipboard-manager-linux-amd64 /usr/local/bin/clipboard-manager' >> build/release/README-RELEASE.md
	@echo 'sudo chmod +x /usr/local/bin/clipboard-manager' >> build/release/README-RELEASE.md
	@echo '```' >> build/release/README-RELEASE.md
	@echo '' >> build/release/README-RELEASE.md
	@echo '## Usage' >> build/release/README-RELEASE.md
	@echo '' >> build/release/README-RELEASE.md
	@echo '- Press **Super+V** to open clipboard history' >> build/release/README-RELEASE.md
	@echo '- Run `clipboard-manager help` for all options' >> build/release/README-RELEASE.md
	@echo '- Run `clipboard-manager list` for terminal interface' >> build/release/README-RELEASE.md
	
	@echo "‚úÖ Release package created in build/release/"
	@echo "Contents:"
	@ls -la build/release/
	@echo ""
	@echo "üì¶ Ready for distribution! Users can run ./install.sh without Go installed."

# Create distributable archive
dist: release
	@echo "üì¶ Creating distributable archive..."
	@cd build && tar -czf clipboard-manager-release.tar.gz release/
	@echo "‚úÖ Created build/clipboard-manager-release.tar.gz"
	@echo "üì§ Ready to distribute! Users can:"
	@echo "   1. Download and extract the archive"
	@echo "   2. Run ./install.sh (no Go required)"
	@echo ""
	@echo "Archive size: $$(du -h build/clipboard-manager-release.tar.gz | cut -f1)"

# Run all tests
test:
	@echo "üß™ Running tests..."
	@./tests/run_tests.sh

# Run tests with coverage
test-coverage:
	@echo "üß™ Running tests with coverage..."
	go test -v -coverprofile=coverage.out
	go tool cover -html=coverage.out -o coverage.html
	@echo "‚úÖ Coverage report generated: coverage.html"

# Clean build artifacts
clean:
	@echo "üßπ Cleaning build artifacts..."
	rm -f clipboard-manager
	rm -f clipboard-manager-test
	rm -f tests/clipboard-manager-test
	rm -f build/clipboard-manager*
	rm -f coverage.out
	rm -f coverage.html
	go clean
	@echo "‚úÖ Clean completed!"

# Install dependencies
deps:
	@echo "üì¶ Installing dependencies..."
	go mod tidy
	go mod download
	@echo "‚úÖ Dependencies installed!"

# Run the application
run:
	@echo "üöÄ Starting Clipboard Manager..."
	./clipboard-manager

# Run in daemon mode
daemon:
	@echo "üîß Starting Clipboard Manager daemon..."
	./clipboard-manager daemon

# Show GUI
show:
	@echo "üñ•Ô∏è  Opening Clipboard Manager GUI..."
	./clipboard-manager show

# Install system-wide (requires sudo)
install: build
	@echo "üì• Installing system-wide..."
	sudo cp clipboard-manager /usr/local/bin/
	@echo "üîß Setting up desktop integration..."
	@mkdir -p ~/.local/share/applications
	@echo "[Desktop Entry]" > ~/.local/share/applications/clipboard-manager.desktop
	@echo "Name=Clipboard Manager" >> ~/.local/share/applications/clipboard-manager.desktop
	@echo "Comment=Clipboard history manager for Linux" >> ~/.local/share/applications/clipboard-manager.desktop
	@echo "Exec=/usr/local/bin/clipboard-manager show" >> ~/.local/share/applications/clipboard-manager.desktop
	@echo "Icon=edit-copy" >> ~/.local/share/applications/clipboard-manager.desktop
	@echo "Terminal=false" >> ~/.local/share/applications/clipboard-manager.desktop
	@echo "Type=Application" >> ~/.local/share/applications/clipboard-manager.desktop
	@echo "Categories=Utility;" >> ~/.local/share/applications/clipboard-manager.desktop
	@echo "Keywords=clipboard;history;copy;paste;" >> ~/.local/share/applications/clipboard-manager.desktop
	@echo "üîë Setting up hotkey (Ctrl+Shift+V)..."
	@/usr/local/bin/clipboard-manager daemon > /dev/null 2>&1 &
	@echo "üöÄ Setting up autostart..."
	@mkdir -p ~/.config/autostart
	@echo "[Desktop Entry]" > ~/.config/autostart/clipboard-manager.desktop
	@echo "Name=Clipboard Manager" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "GenericName=Clipboard History Manager" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "Comment=Clipboard history manager with Ctrl+Shift+V hotkey" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "Exec=/usr/local/bin/clipboard-manager daemon" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "Icon=edit-copy" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "Terminal=false" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "Type=Application" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "Categories=Utility;System;Accessibility;" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "Keywords=clipboard;history;copy;paste;hotkey;" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "X-GNOME-Autostart-enabled=true" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "X-KDE-autostart-after=panel" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "X-MATE-Autostart-enabled=true" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "X-XFCE-Autostart-enabled=true" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "Hidden=false" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "NoDisplay=false" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "StartupNotify=false" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "X-GNOME-Autostart-Delay=3" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "X-KDE-StartupNotify=false" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "OnlyShowIn=GNOME;KDE;XFCE;MATE;Unity;Cinnamon;Pantheon;LXQt;LXDE;" >> ~/.config/autostart/clipboard-manager.desktop
	@echo "‚úÖ Installation completed!"
	@echo "   ‚Ä¢ Binary: /usr/local/bin/clipboard-manager"
	@echo "   ‚Ä¢ Desktop entry: ~/.local/share/applications/clipboard-manager.desktop"
	@echo "   ‚Ä¢ Autostart entry: ~/.config/autostart/clipboard-manager.desktop"
	@echo "   ‚Ä¢ Hotkey: Ctrl+Shift+V (configured automatically)"
	@echo ""
	@echo "üöÄ Startup Application:"
	@echo "   ‚Ä¢ Added to system startup applications list"
	@echo "   ‚Ä¢ Will start automatically on login"
	@echo "   ‚Ä¢ Visible in your desktop's startup applications manager"
	@echo "   ‚Ä¢ Can be managed through System Settings > Startup Applications"
	@echo ""
	@echo "Usage:"
	@echo "   ‚Ä¢ Press Ctrl+Shift+V from anywhere to open clipboard history"
	@echo "   ‚Ä¢ Clipboard manager will start automatically on login"
	@echo "   ‚Ä¢ Run 'clipboard-manager help' for more options"

# Uninstall system-wide (requires sudo)
uninstall:
	@echo "üóëÔ∏è  Uninstalling system-wide..."
	@echo "Stopping any running processes..."
	@pkill -f clipboard-manager || true
	@echo "Removing system binary..."
	sudo rm -f /usr/local/bin/clipboard-manager
	@echo "Removing desktop integration..."
	@rm -f ~/.local/share/applications/clipboard-manager.desktop
	@echo "Removing autostart entry..."
	@rm -f ~/.config/autostart/clipboard-manager.desktop
	@echo "Removing hotkey configuration..."
	@gsettings reset org.gnome.settings-daemon.plugins.media-keys custom-keybindings 2>/dev/null || true
	@echo "‚úÖ System-wide uninstall completed!"

# Complete uninstall (removes everything)
uninstall-complete: uninstall
	@echo "üóëÔ∏è  Running complete uninstall..."
	@echo "Removing user data..."
	@rm -rf ~/.local/share/clipboard-manager
	@echo "Removing configuration files..."
	@rm -f ~/.config/clipboard-manager.conf
	@echo "‚úÖ Complete uninstall finished!"
	@echo "All clipboard manager files and data have been removed."

# Help
help:
	@echo "Clipboard Manager - Available targets:"
	@echo ""
	@echo "  build          - Build the clipboard manager binary"
	@echo "  build-all      - Build multiple variants (standard, debug, optimized)"
	@echo "  release        - Create release package with documentation"
	@echo "  dist           - Create distributable archive (no Go required)"
	@echo "  test           - Run all tests"
	@echo "  test-coverage  - Run tests with coverage report"
	@echo "  clean          - Clean build artifacts"
	@echo "  deps           - Install/update dependencies"
	@echo "  run            - Run the application"
	@echo "  daemon         - Run in daemon mode"
	@echo "  show           - Show GUI"
	@echo "  install        - Install system-wide (requires sudo)"
	@echo "  uninstall      - Uninstall system-wide (requires sudo)"
	@echo "  uninstall-complete - Complete uninstall (removes everything)"
	@echo "  help           - Show this help"
	@echo ""
	@echo "Examples:"
	@echo "  make build     # Build the application"
	@echo "  make build-all # Build all variants"
	@echo "  make release   # Create release package"
	@echo "  make test      # Run tests"
	@echo "  make clean     # Clean up"